{
  "id": "dao-house-pl-verification-v3",
  "name": "DAO House P&L Verification & Distribution",
  "description": "Validates profit & loss documents with Gemini signature verification and automatically distributes profits",
  "version": "3.0",
  "scenario": {
    "version": "3.0",
    "nodes": [
      {
        "nodeId": "DocumentEventSource",
        "displayName": "Document Processed Events",
        "description": "Reads document.processed events from execution queue",
        "position": {
          "x": 50,
          "y": 100
        },
        "type": "ExternalEventSource",
        "eventType": "document.processed",
        "outputs": [
          {
            "name": "documentEvent",
            "destinationNodeId": "EventMatcher",
            "destinationInputName": "docInput",
            "interface": {
              "type": "Event",
              "requiredFields": ["data.documentId", "data.fileName", "data.textContent", "data.jsonContent"]
            }
          }
        ]
      },
      {
        "nodeId": "GeminiEventSource",
        "displayName": "Gemini Verification Events",
        "description": "Reads gemini.signature.verified events from execution queue",
        "position": {
          "x": 50,
          "y": 250
        },
        "type": "ExternalEventSource",
        "eventType": "gemini.signature.verified",
        "outputs": [
          {
            "name": "geminiEvent",
            "destinationNodeId": "EventMatcher",
            "destinationInputName": "geminiInput",
            "interface": {
              "type": "Event",
              "requiredFields": ["data.documentId", "data.isValid", "data.reliabilityScore"]
            }
          }
        ]
      },
      {
        "nodeId": "EventMatcher",
        "displayName": "Match Events by Document ID",
        "description": "Matches document.processed with gemini.signature.verified events by documentId",
        "position": {
          "x": 350,
          "y": 175
        },
        "type": "ProcessNode",
        "inputs": [
          {
            "name": "docInput",
            "interface": {
              "type": "Event",
              "requiredFields": ["data.documentId"]
            },
            "required": true
          },
          {
            "name": "geminiInput",
            "interface": {
              "type": "Event",
              "requiredFields": ["data.documentId"]
            },
            "required": true
          }
        ],
        "outputs": [
          {
            "name": "matchedPair",
            "destinationNodeId": "DataFilter",
            "destinationInputName": "eventPair",
            "interface": {
              "type": "MatchedEvents",
              "requiredFields": []
            }
          }
        ],
        "processing": {
          "type": "transform",
          "description": "Matches events by documentId and combines their data",
          "formula": "if (docInput.data.documentId === geminiInput.data.documentId) { return { document: docInput, gemini: geminiInput, documentId: docInput.data.documentId, matched: true }; } else { return null; }"
        }
      },
      {
        "nodeId": "DataFilter",
        "displayName": "Filter P&L Documents",
        "description": "Filters for Profit & Loss documents only",
        "position": {
          "x": 650,
          "y": 175
        },
        "type": "ProcessNode",
        "inputs": [
          {
            "name": "eventPair",
            "interface": {
              "type": "MatchedEvents",
              "requiredFields": []
            },
            "required": true
          }
        ],
        "outputs": [
          {
            "name": "filteredData",
            "destinationNodeId": "FieldExtractor",
            "destinationInputName": "matchedData",
            "interface": {
              "type": "MatchedEvents",
              "requiredFields": []
            }
          }
        ],
        "processing": {
          "type": "transform",
          "description": "Checks if document contains 'Profit' and 'Net Profit'",
          "formula": "const text = eventPair.document.data.textContent || ''; const jsonType = eventPair.document.data.jsonContent?.documentType || ''; if ((jsonType.includes('Profit') || text.includes('Profit')) && text.includes('Net Profit')) { return eventPair; } else { return null; }"
        }
      },
      {
        "nodeId": "FieldExtractor",
        "displayName": "Extract & Transform Fields",
        "description": "Extracts key fields and applies regex transformation to extract net profit amount",
        "position": {
          "x": 950,
          "y": 175
        },
        "type": "ProcessNode",
        "inputs": [
          {
            "name": "matchedData",
            "interface": {
              "type": "MatchedEvents",
              "requiredFields": []
            },
            "required": true
          }
        ],
        "outputs": [
          {
            "name": "extractedData",
            "destinationNodeId": "ValidationFSM",
            "destinationInputName": "dataInput",
            "interface": {
              "type": "ExtractedData",
              "requiredFields": []
            }
          }
        ],
        "processing": {
          "type": "transform",
          "description": "Extracts fields and parses net profit from text using regex",
          "formula": "const doc = matchedData.document.data; const gem = matchedData.gemini.data; const textMatch = doc.textContent.match(/Net Profit[:\\s]+\\$?([0-9,.]+)/); const netProfitStr = textMatch ? textMatch[1] : null; const netProfit = netProfitStr ? parseFloat(netProfitStr.replace(/,/g, '')) : 0; return { fileName: doc.fileName, documentId: doc.documentId, textContent: doc.textContent, isSignatureValid: gem.isValid, reliabilityScore: gem.reliabilityScore, signedBy: gem.signedBy, verifiedAt: gem.verifiedAt, netProfit: netProfit, netProfitAmount: netProfit };"
        }
      },
      {
        "nodeId": "ValidationFSM",
        "displayName": "P&L Validation State Machine",
        "description": "Validates signature, reliability score, and net profit amount",
        "position": {
          "x": 1250,
          "y": 175
        },
        "type": "FSMProcessNode",
        "inputs": [
          {
            "name": "dataInput",
            "interface": {
              "type": "ExtractedData",
              "requiredFields": []
            },
            "required": true
          }
        ],
        "outputs": [
          {
            "name": "approved",
            "destinationNodeId": "DistributionCalc",
            "destinationInputName": "approvedData",
            "interface": {
              "type": "ValidatedData",
              "requiredFields": []
            }
          },
          {
            "name": "rejected",
            "destinationNodeId": "RejectedSink",
            "destinationInputName": "rejectedData",
            "interface": {
              "type": "ValidatedData",
              "requiredFields": []
            }
          }
        ],
        "fsm": {
          "states": [
            {
              "name": "Validating",
              "onEntry": [
                {
                  "action": "log",
                  "value": "Validating P&L document"
                }
              ]
            },
            {
              "name": "Approved",
              "onEntry": [
                {
                  "action": "emit",
                  "target": "approved",
                  "formula": "{ ...dataInput, status: 'approved', approvedAt: new Date().toISOString() }"
                },
                {
                  "action": "log",
                  "value": "P&L document approved"
                }
              ]
            },
            {
              "name": "Rejected",
              "onEntry": [
                {
                  "action": "emit",
                  "target": "rejected",
                  "formula": "{ ...dataInput, status: 'rejected', rejectedAt: new Date().toISOString(), reason: 'Failed validation criteria' }"
                },
                {
                  "action": "log",
                  "value": "P&L document rejected"
                }
              ]
            }
          ],
          "initialState": "Validating",
          "transitions": [
            {
              "from": "Validating",
              "to": "Approved",
              "trigger": "default",
              "guard": "dataInput.isSignatureValid === true && dataInput.reliabilityScore > 70 && dataInput.netProfitAmount > 0"
            },
            {
              "from": "Validating",
              "to": "Rejected",
              "trigger": "default",
              "guard": "!(dataInput.isSignatureValid === true && dataInput.reliabilityScore > 70 && dataInput.netProfitAmount > 0)"
            }
          ],
          "variables": {}
        }
      },
      {
        "nodeId": "DistributionCalc",
        "displayName": "Calculate Profit Distribution",
        "description": "Calculates distribution amount (90%) and reserve (10%)",
        "position": {
          "x": 1550,
          "y": 100
        },
        "type": "ProcessNode",
        "inputs": [
          {
            "name": "approvedData",
            "interface": {
              "type": "ValidatedData",
              "requiredFields": []
            },
            "required": true
          }
        ],
        "outputs": [
          {
            "name": "distribution",
            "destinationNodeId": "ApprovedSink",
            "destinationInputName": "result",
            "interface": {
              "type": "DistributionResult",
              "requiredFields": []
            }
          }
        ],
        "processing": {
          "type": "transform",
          "description": "Calculates 90% for distribution and 10% for reserve",
          "formula": "const netProfit = approvedData.netProfitAmount || 0; const distributionAmount = netProfit * 0.9; const reserveAmount = netProfit * 0.1; return { ...approvedData, distributionAmount, reserveAmount, calculatedAt: new Date().toISOString() };"
        }
      },
      {
        "nodeId": "ApprovedSink",
        "displayName": "Approved P&L Results",
        "description": "Stores approved P&L verification results with distribution calculations",
        "position": {
          "x": 1850,
          "y": 100
        },
        "type": "Sink",
        "inputs": [
          {
            "name": "result",
            "interface": {
              "type": "DistributionResult",
              "requiredFields": []
            },
            "required": true
          }
        ]
      },
      {
        "nodeId": "RejectedSink",
        "displayName": "Rejected Documents",
        "description": "Stores rejected documents for review",
        "position": {
          "x": 1550,
          "y": 300
        },
        "type": "Sink",
        "inputs": [
          {
            "name": "rejectedData",
            "interface": {
              "type": "ValidatedData",
              "requiredFields": []
            },
            "required": true
          }
        ]
      }
    ],
    "edges": [],
    "groups": {
      "visualMode": "all",
      "activeFilters": []
    }
  }
}
